<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[CrowdChat Engineering]]></title>
  <link href="http://crowdchat.github.io/atom.xml" rel="self"/>
  <link href="http://crowdchat.github.io/"/>
  <updated>2014-04-12T21:29:59-07:00</updated>
  <id>http://crowdchat.github.io/</id>
  <author>
    <name><![CDATA[CrowdChat Engineering]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Integrating Facebook Graph API]]></title>
    <link href="http://crowdchat.github.io/blog/2014/04/11/integrating-facebook-graph-api/"/>
    <updated>2014-04-11T12:37:00-07:00</updated>
    <id>http://crowdchat.github.io/blog/2014/04/11/integrating-facebook-graph-api</id>
    <content type="html"><![CDATA[<p>Facebook is undoubtedly the most popular social media site out on the internet and surprisingly it was difficult to find good support on accessing the Graph API using Node.js. So this is the approach we followed to perform basic actions on facebook for our app.</p>

<!-- more -->


<p><strong>STEP 1 : CREATE AN APP</strong>
First up is to create an app if you dont have one. This our mode to access facebook externally. So here are the steps
a) Log on to <a href="https://developers.facebook.com">developers facebook page</a> and sign in. Once there click on the app menu in the menu bar and select &ldquo;create a new app&rdquo;.
b) Follow the subsequent steps and once the app is successfully created, you will be redirected to the dashboard page of your application.
c) You will find the a settings tab on the left hand side. Click on the tab and enter the domain from which you would be trying to access the facebook API. <em> If you are using your local machine for development, enter &ldquo;localhost&rdquo;</em>
d) Keep a note of the AppID and AppSecret as we will be using these to exchange information with facebook.</p>

<p><strong>STEP 2 : VERIFICATION and AUTHORIZATION</strong>
Now that we have set up a facebook app, we now need a user to authorize the app to perform actions on his behalf. A user can authorize the app created using the OAuth protocol. Facebook only supports OAuth 2.0 unlike twitter which only supports OAuth 1.0 and LinkedIN which supports both the versions. So the steps for authorizing are slightly different when compared to twitter and LinkedIN.
We would be needing the following node modules1) node-oauth <a href="https://github.com/ciaranj/node-oauth"> Link on GIT Hub</a>2) request <a href="https://github.com/mikeal/request"> Link on GIT Hub</a>
Changes in package.json :     &ldquo;oauth&rdquo;: &ldquo;0.9.10&rdquo;,     &ldquo;request&rdquo;: &ldquo;2.30.0&rdquo;
Since we were using express middleware for our application. Here is the code involved to validate the app.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;request&#39;</span><span class="p">);</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">OAuth2</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;oauth&#39;</span><span class="p">).</span><span class="nx">OAuth2</span><span class="p">;</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">oauth2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OAuth2</span><span class="p">(</span><span class="s2">&quot;YOUR Facebook APP ID&quot;</span><span class="p">,</span><span class="s2">&quot;YOUR Facebook APP SECRET&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;https://www.facebook.com/dialog/oauth&quot;</span><span class="p">,</span><span class="s2">&quot;https://graph.facebook.com/oauth/access_token&quot;</span><span class="p">,</span><span class="kc">null</span><span class="p">);</span>
</span><span class='line'><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/facebook/auth&#39;</span><span class="p">,</span><span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">redirect_uri</span> <span class="o">=</span> <span class="s2">&quot;Your App domain&quot;</span> <span class="o">+</span> <span class="s2">&quot;/Path_To_Be_Redirected_to_After_Verification&quot;</span><span class="p">;</span>    <span class="c1">// For eg. &quot;http://localhost:3000/facebook/callback&quot;    </span>
</span><span class='line'><span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;redirect_uri&#39;</span><span class="o">:</span> <span class="nx">redirect_uri</span><span class="p">,</span> <span class="s1">&#39;scope&#39;</span><span class="o">:</span><span class="s1">&#39;user_about_me,publish_actions&#39;</span><span class="p">};</span>
</span><span class='line'><span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="nx">oauth2</span><span class="p">.</span><span class="nx">getAuthorizeUrl</span><span class="p">(</span><span class="nx">params</span><span class="p">));});</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now every time you hit the path &ldquo;/facebook/auth&rdquo; from your web application you will hit this method.The redirect_uri parameter mentions which URI to be redirected to by facebook. Remember the domain of this URI must be the one mentioned in the settings of the facebook app. The scope parameter is a comma seperated list of permissions the user has to authorize the app. For example, the permission &ldquo;user_about_me&rdquo; allows the app to access the complete profile of the user and the permission &ldquo;publish_actions&rdquo; allows the app to post, like , share and perform other actions on the behalf of the user. A comprehensive list of permissions can be referred from the <a href="https://developers.facebook.com/docs/reference/login/">facebook permissions</a> page.
Once facebook successfully verfies these credentials the app is redirected to the redirect_uri with a query parameter called &ldquo;code&rdquo; appended to it. This code can then be successfully exchanged for the user&rsquo;s access token.Here&rsquo;s the snippet:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;/Path_To_Be_Redirected_to_After_Verification&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>   
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">error_reason</span><span class="p">)</span> <span class="p">{</span>        
</span><span class='line'><span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">error_reason</span><span class="p">);</span>   
</span><span class='line'><span class="p">}</span>  
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">code</span><span class="p">)</span> <span class="p">{</span>       
</span><span class='line'><span class="kd">var</span> <span class="nx">loginCode</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">code</span><span class="p">;</span>       
</span><span class='line'><span class="kd">var</span> <span class="nx">redirect_uri</span> <span class="o">=</span> <span class="nx">same_as_previous_redirect_uri</span><span class="p">;</span> <span class="c1">// Path_To_Be_Redirected_to_After_Verification                // For eg. &quot;/facebook/callback&quot;      </span>
</span><span class='line'><span class="nx">oauth2</span><span class="p">.</span><span class="nx">getOAuthAccessToken</span><span class="p">(</span><span class="nx">loginCode</span><span class="p">,{</span> <span class="nx">grant_type</span><span class="o">:</span> <span class="s1">&#39;authorization_code&#39;</span><span class="p">,</span> <span class="nx">redirect_uri</span><span class="o">:</span> <span class="nx">redirect_uri</span><span class="p">},</span>
</span><span class='line'>     <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">accessToken</span><span class="p">,</span> <span class="nx">refreshToken</span><span class="p">,</span> <span class="nx">params</span><span class="p">){</span>             
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>             <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>     
</span><span class='line'>             <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>              
</span><span class='line'>      <span class="p">}</span>                
</span><span class='line'>      <span class="kd">var</span> <span class="nx">access_token</span> <span class="o">=</span> <span class="nx">accessToken</span><span class="p">;</span>               
</span><span class='line'>      <span class="kd">var</span> <span class="nx">expires</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">expires</span><span class="p">;</span>
</span><span class='line'>      <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">access_token</span> <span class="o">=</span> <span class="nx">access_token</span><span class="p">;</span>
</span><span class='line'>      <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">expires</span> <span class="o">=</span> <span class="nx">expires</span><span class="p">;</span>          
</span><span class='line'>   <span class="p">});</span> 
</span><span class='line'> <span class="p">}};)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now when facebook redirects to the redirect_uri we then take the query paramter &ldquo;code&rdquo; and exchange it for the users&rsquo;s access token. We use the getOAuthAccessToken method provided by the node-oauth module with the parameters as shown in the snippet above. The important point to be noted is that the redirect URI mentioned here should be same as that of the redirect_uri mentioned while verification as facebook uses this URI to verify if the same web application is accessing it.
If the user successfully authorizes the app an error will not be returned and the access_token along with its expiry time is returned(which is typically around one month). Post the expiry period a new access token has to be requested.
The access_token has to be stored because to perform any action on behalf of the user we will require it. In this case we are just storing it in the session.</p>

<p><strong>STEP 3 : GET USER PROFILE</strong>
Now that we have a valid access_token impossible is nothing, well atleast for the permissions you have authorization. Since the user has already given us access for viewing his profile let us fetch it using the graph API. Graph API being restful allows us to access/modify it using basic REST methods like GET, POST, PUT or DELETE.
For getting the user profile check the following code snippet</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/get_fb_profile&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>  
</span><span class='line'> <span class="nx">oauth2</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;https://graph.facebook.com/me&quot;</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">accessToken</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span> <span class="p">,</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>   <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>         
</span><span class='line'>       <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>           
</span><span class='line'>       <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>        
</span><span class='line'>   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>          
</span><span class='line'>       <span class="kd">var</span> <span class="nx">profile</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>            
</span><span class='line'>       <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">profile</span><span class="p">);</span>
</span><span class='line'>       <span class="kd">var</span> <span class="nx">profile_img_url</span> <span class="o">=</span> <span class="s2">&quot;https://graph.facebook.com/&quot;</span><span class="o">+</span><span class="nx">profile</span><span class="p">.</span><span class="nx">id</span><span class="o">+</span><span class="err">&quot;</span><span class="o">/</span><span class="nx">picture</span><span class="p">;</span>        
</span><span class='line'>   <span class="p">}</span>   
</span><span class='line'> <span class="p">});});</span>
</span></code></pre></td></tr></table></div></figure>


<p>As we can see, we just need to send a get request to &ldquo;<a href="https://graph.facebook.com/me">https://graph.facebook.com/me</a>&rdquo; with the access token as a query parameter and the response will contain the user profile as a JSON string. The profile_img_url is not explicitly returned using this request but can be obtained as shown in the snippet above.</p>

<p><strong>STEP 4 : POST/SHARE ON USER&rsquo;S WALL</strong>
A post on the user&rsquo;s wall can be done by using a simple http POST method with the post parameters in the request body. Now the node-auth module is not very user friendly on performing custom http requests. So we decided to go with the &ldquo;request&rdquo; module. Check out the following snippet, you&rsquo;ll understand better</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/post_to_fb&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>   
</span><span class='line'>  <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="s1">&#39;https://graph.facebook.com/me/feed&#39;</span><span class="p">;</span>   
</span><span class='line'>  <span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span>    
</span><span class='line'>    <span class="nx">access_token</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">access_token</span><span class="p">,</span><span class="nx">message</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">text</span><span class="p">,</span><span class="nx">link</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">url</span>             
</span><span class='line'>  <span class="p">};</span>   
</span><span class='line'>  <span class="nx">request</span><span class="p">.</span><span class="nx">post</span><span class="p">({</span><span class="nx">url</span><span class="o">:</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">qs</span><span class="o">:</span> <span class="nx">params</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">resp</span><span class="p">,</span> <span class="nx">body</span><span class="p">)</span> <span class="p">{</span>   
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>           
</span><span class='line'>    <span class="k">return</span><span class="p">;</span> 
</span><span class='line'>  <span class="p">}</span>    
</span><span class='line'>   <span class="nx">body</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">body</span><span class="p">);</span>   
</span><span class='line'>   <span class="k">if</span> <span class="p">(</span><span class="nx">body</span><span class="p">.</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>       
</span><span class='line'>    <span class="kd">var</span> <span class="nx">error</span> <span class="o">=</span> <span class="nx">body</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">;</span>           
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;Error returned from facebook: &quot;</span><span class="o">+</span> <span class="nx">body</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>          
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">body</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">code</span> <span class="o">==</span> <span class="mi">341</span><span class="p">)</span> <span class="p">{</span>            
</span><span class='line'>      <span class="nx">error</span> <span class="o">=</span> <span class="s2">&quot;You have reached the post limit for facebook. Please wait for 24 hours before posting again to facebook.&quot;</span>         
</span><span class='line'>      <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>          
</span><span class='line'>    <span class="p">}</span>          
</span><span class='line'>    <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
</span><span class='line'>   <span class="p">}</span>   
</span><span class='line'>   <span class="kd">var</span> <span class="nx">return_ids</span> <span class="o">=</span> <span class="nx">body</span><span class="p">.</span><span class="nx">id</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">);</span>    
</span><span class='line'>   <span class="kd">var</span> <span class="nx">user_id</span> <span class="o">=</span> <span class="nx">return_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>  
</span><span class='line'>   <span class="kd">var</span> <span class="nx">post_id</span> <span class="o">=</span> <span class="nx">return_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>  
</span><span class='line'>   <span class="kd">var</span> <span class="nx">post_url</span> <span class="o">=</span> <span class="s2">&quot;https://www.facebook.com/&quot;</span><span class="o">+</span><span class="nx">user_id</span><span class="o">+</span><span class="s2">&quot;/posts/&quot;</span><span class="o">+</span><span class="nx">post_id</span><span class="p">;</span>   
</span><span class='line'>   <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">post_url</span><span class="p">);</span>   
</span><span class='line'>  <span class="p">});});</span>
</span></code></pre></td></tr></table></div></figure>


<p>So, with the help of &ldquo;request&rdquo; we are sending a http POST request to the graph API on &ldquo;<a href="https://graph.facebook.com/me/feed">https://graph.facebook.com/me/feed</a>&rdquo;. We are assuming that all the parameters are accessed from the body of the node request object(req). The access token however is accessed from the session.  A complete set of parameters that can be sent to the facebook POST object can be accessed on the <a href="https://developers.facebook.com/docs/reference/api/post/">facebook post object</a> page.
An important point to be noted is that the facebook bot actually crawls through the parameter mentioned in the parameter link and constructs  the facebook card. So be careful not to give &ldquo;localhost&rdquo; domain. Cause this will throw an error. A precaution has to be taken not to post wildly(spam) because facebook may then consider you to be a bot and prevent you from posting for sometime(Mostly around 24 hours). So be careful when you aure developing.
If the post to the user&rsquo;s wall is successful, facebook will return two long numbers seperated by an underscore(_). The first number is the user_id and the second number is the post_id. So the post can be directly accessed by the URL constructed in the code snippet.
Sharing is similar to posting but the only difference is that in the parameter link, the url of the feed to be shared has to be mentioned. The response obtained is also in the same format as that of posting.</p>

<p><strong>STEP 5 : LIKE/UNLIKE A FEED</strong>
Now that we&rsquo;ve posted something on facebook lets check out how can like it and then unlike it. Check out the snippet shown below.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/like_unlike_post&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>    
</span><span class='line'>  <span class="kd">var</span> <span class="nx">post_id</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">post_id</span><span class="p">;</span> 
</span><span class='line'>  <span class="kd">var</span> <span class="nx">action</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">action</span><span class="p">;</span>   <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="s1">&#39;https://graph.facebook.com/&#39;</span><span class="o">+</span><span class="nx">post_id</span><span class="o">+</span><span class="s1">&#39;/likes&#39;</span><span class="p">;</span>   
</span><span class='line'>  <span class="kd">var</span> <span class="nx">method</span><span class="p">;</span>  <span class="k">if</span> <span class="p">(</span> <span class="nx">action</span> <span class="o">==</span> <span class="s1">&#39;like&#39;</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">method</span> <span class="o">=</span> <span class="s1">&#39;POST&#39;</span><span class="p">;</span>    
</span><span class='line'>  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">action</span> <span class="o">==</span> <span class="s1">&#39;unlike&#39;</span> <span class="p">)</span> <span class="p">{</span>     
</span><span class='line'>    <span class="nx">method</span> <span class="o">=</span> <span class="s1">&#39;DELETE&#39;</span><span class="p">;</span>  <span class="p">}</span>    
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="nx">method</span><span class="p">)</span> <span class="p">{</span>   
</span><span class='line'>    <span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">access_token</span><span class="o">:</span> <span class="nx">access_token</span><span class="p">,</span>       
</span><span class='line'>    <span class="p">};</span>         
</span><span class='line'>  <span class="nx">request</span><span class="p">({</span><span class="nx">url</span><span class="o">:</span><span class="nx">url</span> <span class="p">,</span> <span class="nx">method</span><span class="o">:</span><span class="nx">method</span><span class="p">,</span> <span class="nx">qs</span><span class="o">:</span> <span class="nx">params</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">resp</span><span class="p">,</span> <span class="nx">body</span><span class="p">)</span> <span class="p">{</span>          
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>       <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;Error while performing &quot;</span><span class="o">+</span><span class="nx">action</span><span class="o">+</span><span class="s2">&quot; on fb :&quot;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">);</span>                
</span><span class='line'>       <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>            
</span><span class='line'>    <span class="p">}</span>          
</span><span class='line'>    <span class="nx">body</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">body</span><span class="p">);</span>          
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">body</span><span class="p">.</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>              
</span><span class='line'>       <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;Error while performing &quot;</span><span class="o">+</span><span class="nx">action</span><span class="o">+</span><span class="s2">&quot; on fb :&quot;</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">body</span><span class="p">.</span><span class="nx">error</span><span class="p">));</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">body</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>       <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">&quot;You do not have the permission to like the post.&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>                 
</span><span class='line'>       <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">body</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>               
</span><span class='line'>    <span class="p">}</span> <span class="k">return</span><span class="p">;</span>            
</span><span class='line'>   <span class="p">}</span>           
</span><span class='line'>   <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">action</span> <span class="o">+</span> <span class="s2">&quot; Successful&quot;</span><span class="p">);</span>        
</span><span class='line'>   <span class="p">});</span> 
</span><span class='line'>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>       
</span><span class='line'> <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">&quot;Action not mentioned&quot;</span><span class="p">);</span> 
</span><span class='line'><span class="p">}});</span>
</span></code></pre></td></tr></table></div></figure>


<p>Like and unlike are performed on the same graph api url, the only difference being the request method used to access it. For &ldquo;like&rdquo;, a POST request has to be sent and for &ldquo;unlike&rdquo; a DELETE request. If the user has decided to keep his post private or if the post has been deleted, facebook will return an error with error code 200. So you can handle it accordingly.
That kinda sums up the basics of using the graph api using node js. There is much more we can do using the graph API but now we can atleast use this as a stable and simple platform to work on the graph API.</p>

<p><strong>SHOUT OUTS</strong>
Thanks to <a href="https://twitter.com/@non_local">@non_local</a> and <a href="https://twitter.com/@geekpack">@geekpack</a> for allowing me to work on this endeavor of theirs.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Identifying Real Humans on Twitter]]></title>
    <link href="http://crowdchat.github.io/blog/2013/11/06/identifying-real-humans-on-twitter/"/>
    <updated>2013-11-06T16:58:00-08:00</updated>
    <id>http://crowdchat.github.io/blog/2013/11/06/identifying-real-humans-on-twitter</id>
    <content type="html"><![CDATA[<p>In CrowdChat platform, we have classified over 66M Twitter accounts and counting. The important precursor
step: Finding out real-humans among those millions of accounts. This may appear as seemingly intuitive task for any average person, but is not so for the machines. This post descirbes how we approached the problem. The reader should refer further for the following concepts, but we will try to introduce them as briefly as possible.</p>

<!-- more -->


<p>The of problem of identifying, if a twitter account belongs to real-human or not can be translated to the problem of identifying if their self-described bio belongs to a language class H.</p>

<p>Lets assume for now, H is language class of all self-described bios that sound like written by Humans.
And B is the language class of all bios that are written by Bots/Organization Accounts/Non-Humans.</p>

<p>A given tweet (in English) is composed of set of character n-grams.</p>

<h1>EM Algorithm</h1>

<p>Let’s recall the naive Bayes algorithm: given a tweet (a set of character n-grams), we estimate its language to be the language L that maximizes</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>P(language=L|ngrams)∝P(ngrams|language=L)P(language=L)
</span><span class='line'>Thus, we need to estimate P(ngram|language=L) and P(language=L).</span></code></pre></td></tr></table></div></figure>


<p>This would be easy if we knew the language of each tweet, since we could estimate</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>P(xyz|language=English) as #(number of times “xyz” is a trigram in the English tweets) / #(total trigrams in the English tweets)
</span><span class='line'>P(language=English) as the proportion of English tweets.
</span></code></pre></td></tr></table></div></figure>


<p>Or, it would also be easy if we knew the n-gram probabilities for each language, since we could use Bayes’ theorem to compute the language probabilities for each tweet, and then take a weighted variant of the previous paragraph.</p>
]]></content>
  </entry>
  
</feed>
